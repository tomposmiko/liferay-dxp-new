@component-name = "portal-user-management-and-portal-configuration"
definition {
	property portal.release = "true";
	property portal.upstream = "true";
	property testray.main.component.name = "User Groups";

	setUp {
		TestCase.setUpPortalInstance();

		User.firstLoginPG();
	}

	tearDown {
		var testPortalInstance = PropsUtil.get("test.portal.instance");

		if ("${testPortalInstance}" == "true") {
			PortalInstances.tearDownCP();
		}
		else {
			User.tearDownCP();

			UserGroup.tearDownCP();

			Role.tearDownCP();

			Site.tearDownCP();

			Organization.tearDownCP();
		}
	}

	@priority = "3"
	test ExportUserGroupMembers {
		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		User.addCP(
			userEmailAddress = "userea1@liferay.com",
			userFirstName = "userfn1",
			userLastName = "userln1",
			userScreenName = "usersn1"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		User.addCP(
			userEmailAddress = "userea2@liferay.com",
			userFirstName = "userfn2",
			userLastName = "userln2",
			userScreenName = "usersn2"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "User Groups"
		);

		UserGroup.addCP(userGroupName = "UG UserGroup Name");

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "User Groups"
		);

		UserGroup.assignMemberCP(
			userGroupName = "UG UserGroup Name",
			userScreenName = "usersn1"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "User Groups"
		);

		UserGroup.assignMemberCP(
			userGroupName = "UG UserGroup Name",
			userScreenName = "usersn2"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "User Groups"
		);

		LAR.exportUserGroups(larFileName = "User_Group_Members.lar");
	}

	@priority = "4"
	test UserGroupPrivatePageInheritance {
		property custom.properties = "layout.user.private.layouts.auto.create=false${line.separator}user.groups.copy.layouts.to.user.personal.site=true";

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "User Groups"
		);

		UserGroup.addCP(userGroupName = "UG UserGroup Name");

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "User Groups"
		);

		UserGroup.gotoAddPageCP(userGroupName = "UG UserGroup Name");

		ProductMenu.gotoPortlet(
			category = "Build",
			panel = "Site Administration",
			portlet = "Pages"
		);

		SitePages.addPrivatePage(pageName = "Test User Group Page 1");

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		User.addCP(
			userEmailAddress = "userea@liferay.com",
			userFirstName = "userfn",
			userLastName = "userln",
			userScreenName = "usersn"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		User.editPasswordCP(
			userEmailAddress = "userea@liferay.com",
			userScreenName = "usersn"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		Search.searchCP(searchTerm = "userfn");

		var key_rowEntry = "usersn";

		Click(locator1 = "ContentRow#ENTRY_CONTENT_ENTRY_ELLIPSIS");

		MenuItem.click(menuItem = "Manage Pages");

		var key_page = "Test User Group Page 1";

		AssertElementNotPresent(locator1 = "ProductMenu#PAGES");

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "User Groups"
		);

		UserGroup.assignMemberCP(
			userGroupName = "UG UserGroup Name",
			userScreenName = "usersn"
		);

		User.logoutPG();

		User.loginUserPG(password = "test", userEmailAddress = "userea@liferay.com");

		UserBar.gotoDashboard();

		AssertTextEquals(locator1 = "Home#PAGE_1", value1 = "Test User Group Page 1");

		User.logoutUserPG();

		User.loginPG(
			password = "test",
			userEmailAddress = "test@liferay.com",
			userScreenName = "usersn"
		);
	}

	@priority = "4"
	test UserGroupSiteOwnerPermissions {
		property test.name.skip.portal.instance = "UsergroupsUsecase#UserGroupSiteOwnerPermissions";

		ProductMenu.gotoPortlet(
			category = "Configuration",
			panel = "Control Panel",
			portlet = "Search"
		);

		SearchAdministration.executeSearchActions(
			actionsDescription = "Reindex all search indexes."
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Roles"
		);

		Role.definePermissionCP(
			permissionDefinitionKey = "CONTROL_PANEL_GENERAL_PERMISSIONS_GO_TO_CONTROL_PANEL_CHECKBOX",
			permissionDefinitionValue = "View Control Panel Menu",
			permissionNavigationKey = "CONTROL_PANEL_GENERAL_PERMISSIONS",
			permissionNavigationValue = "General Permissions",
			roleTitle = "Authenticated",
			roleUser = "User"
		);

		for (var userNumber : list "1,2,3,4,5") {
			ProductMenu.gotoPortlet(
				category = "Users",
				panel = "Control Panel",
				portlet = "Users and Organizations"
			);

			User.addCP(
				userEmailAddress = "userea${userNumber}@liferay.com",
				userFirstName = "userfn${userNumber}",
				userLastName = "userln${userNumber}",
				userScreenName = "usersn${userNumber}"
			);

			ProductMenu.gotoPortlet(
				category = "Users",
				panel = "Control Panel",
				portlet = "Users and Organizations"
			);

			User.editPasswordCP(
				userEmailAddress = "userea${userNumber}@liferay.com",
				userScreenName = "usersn${userNumber}"
			);
		}

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "User Groups"
		);

		UserGroup.addCP(userGroupName = "UG UserGroup Name");

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "User Groups"
		);

		UserGroup.assignAllMembersCP(userGroupName = "UG UserGroup Name");

		ProductMenu.gotoPortlet(
			category = "Sites",
			panel = "Control Panel",
			portlet = "Sites"
		);

		Site.addBlankCP(siteName = "Site Name");

		ProductMenu.gotoPortlet(
			category = "Build",
			panel = "Site Administration",
			portlet = "Pages"
		);

		SitePages.addPublicPage(pageName = "Site Page Name");

		ProductMenu.gotoSite(site = "Site Name");

		ProductMenu.gotoPortlet(
			category = "Members",
			panel = "Site Administration",
			portlet = "Site Memberships"
		);

		Site.addAllMembersCP(siteName = "Site Name");

		ProductMenu.gotoSite(site = "Site Name");

		ProductMenu.gotoPortlet(
			category = "Members",
			panel = "Site Administration",
			portlet = "Site Memberships"
		);

		Site.assignUserGroupAsMemberCP(
			siteName = "Site Name",
			userGroupName = "UG UserGroup Name"
		);

		ProductMenu.gotoSite(site = "Site Name");

		ProductMenu.gotoPortlet(
			category = "Members",
			panel = "Site Administration",
			portlet = "Site Memberships"
		);

		Navigator.gotoNavItem(navItem = "User Groups");

		Site.assignSiteRoleCP(
			resourceName = "UG UserGroup Name",
			roleTitle = "Site Owner"
		);

		User.logoutPG();

		User.loginUserPG(password = "test", userEmailAddress = "userea3@liferay.com");

		ProductMenu.gotoSite(site = "Site Name");

		ProductMenu.gotoPortlet(
			category = "Members",
			panel = "Site Administration",
			portlet = "Site Memberships"
		);

		LexiconEntry.changeDisplayStyle(displayStyle = "table");

		var key_userScreenName = "usersn3";

		AssertTextEquals.assertPartialText(
			locator1 = "SiteMemberships#USER_TABLE_NAME",
			value1 = "userfn3 userln3"
		);

		AssertTextEquals(
			locator1 = "SiteMemberships#USER_TABLE_SCREEN_NAME",
			value1 = "usersn3"
		);

		LexiconEntry.openEntryMenu(rowEntry = "userfn3 userln3");

		MenuItem.viewPresent(menuItem = "Assign Site Roles");

		User.logoutUserPG();

		User.loginPG(password = "test", userEmailAddress = "test@liferay.com");

		ProductMenu.gotoSite(site = "Site Name");

		ProductMenu.gotoPortlet(
			category = "Members",
			panel = "Site Administration",
			portlet = "Site Memberships"
		);

		Site.removeSiteRolesSiteOwnerUserGroupsCP(userGroupName = "UG UserGroup Name");

		User.logoutPG();

		User.loginUserPG(password = "test", userEmailAddress = "userea5@liferay.com");

		ProductMenu.gotoPortlet(
			category = "Sites",
			panel = "Control Panel",
			portlet = "Sites"
		);

		var key_siteName = "Site Name";

		AssertClick.assertPartialTextClickAt(
			locator1 = "Sites#SITE_TABLE_NAME_UNVIEWABLE",
			value1 = "Site Name"
		);

		User.logoutUserPG();

		User.loginPG(password = "test", userEmailAddress = "test@liferay.com");

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Roles"
		);

		RoleNavigator.gotoRoleType(roleType = "Regular");

		Role.add(roleTitle = "Test UserGroup Role");

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Roles"
		);

		Role.definePermissionCP(
			permissionDefinitionKey = "SITE_ADMIN_CONTENT_BOOKMARKS_GENERAL_PERMISSIONS_ACCESS_IN_SITE_ADMINISTRATION_CHECKBOX",
			permissionDefinitionValue = "Access in Site Administration",
			permissionNavigationKey = "SITE_ADMIN_CONTENT_BOOKMARKS",
			permissionNavigationValue = "Bookmarks",
			roleTitle = "Test UserGroup Role",
			roleUser = "Test UserGroup Role"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Roles"
		);

		RoleNavigator.gotoAssignees(roleTitle = "Test UserGroup Role");

		RoleNavigator.gotoAssigneeType(assigneeType = "User Groups");

		Role.addAssignees(assigneeName = "UG UserGroup Name");

		User.logoutPG();

		User.loginUserPG(password = "test", userEmailAddress = "userea1@liferay.com");

		ProductMenu.gotoPortlet(
			category = "Sites",
			panel = "Control Panel",
			portlet = "Sites"
		);

		var key_siteName = "Site Name";

		AssertClick.assertPartialTextClickAt(
			locator1 = "Sites#SITE_TABLE_NAME",
			value1 = "Site Name"
		);

		User.logoutUserPG();

		User.loginPG(password = "test", userEmailAddress = "test@liferay.com");

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "User Groups"
		);

		UserGroup.removeMemberCP(
			userGroupName = "UG UserGroup Name",
			userScreenName = "test"
		);
	}

	@priority = "4"
	test UserGroupSiteTemplates {
		property test.name.skip.portal.instance = "UsergroupsUsecase#UserGroupSiteTemplates";

		ProductMenu.gotoPortlet(
			category = "Configuration",
			panel = "Control Panel",
			portlet = "Search"
		);

		SearchAdministration.executeSearchActions(
			actionsDescription = "Reindex all search indexes."
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		User.addCP(
			userEmailAddress = "userea@liferay.com",
			userFirstName = "userfn",
			userLastName = "userln",
			userScreenName = "usersn"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		User.editPasswordCP(
			userEmailAddress = "userea@liferay.com",
			userScreenName = "usersn"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "User Groups"
		);

		UserGroup.addCP(userGroupName = "UG UserGroup Name");

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "User Groups"
		);

		UserGroup.assignMemberCP(
			userGroupName = "UG UserGroup Name",
			userScreenName = "test"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "User Groups"
		);

		UserGroup.addSiteCP(
			userGroupName = "UG UserGroup Name",
			userGroupSite = "Community Site"
		);

		UserBar.gotoProfile();

		var key_pageName = "Welcome";

		AssertTextPresent(locator1 = "Home#PAGE_1", value1 = "Welcome");

		AssertTextPresent(locator1 = "Home#PAGE_2", value1 = "Home");

		AssertTextPresent(locator1 = "Home#PAGE_3", value1 = "Wiki");

		UserBar.gotoDashboard();

		AssertTextPresent(locator1 = "Home#PAGE_1", value1 = "Welcome");

		if (IsElementPresent(locator1 = "Home#PAGE_2")) {
			AssertTextNotEquals(locator1 = "Home#PAGE_2", value1 = "Home");
		}

		if (IsElementPresent(locator1 = "Home#PAGE_3")) {
			AssertTextNotEquals(locator1 = "Home#PAGE_3", value1 = "Wiki");
		}

		User.logoutPG();

		User.loginUserPG(password = "test", userEmailAddress = "userea@liferay.com");

		UserBar.gotoProfile();

		var key_pageName = "Welcome";

		AssertTextPresent(locator1 = "Home#PAGE_1", value1 = "Welcome");

		if (IsElementPresent(locator1 = "Home#PAGE_2")) {
			AssertTextNotEquals(locator1 = "Home#PAGE_2", value1 = "Home");
		}

		if (IsElementPresent(locator1 = "Home#PAGE_3")) {
			AssertTextNotEquals(locator1 = "Home#PAGE_3", value1 = "Wiki");
		}

		UserBar.gotoDashboard();

		AssertTextPresent(locator1 = "Home#PAGE_1", value1 = "Welcome");

		if (IsElementPresent(locator1 = "Home#PAGE_2")) {
			AssertTextNotEquals(locator1 = "Home#PAGE_2", value1 = "Home");
		}

		if (IsElementPresent(locator1 = "Home#PAGE_3")) {
			AssertTextNotEquals(locator1 = "Home#PAGE_3", value1 = "Wiki");
		}

		User.logoutPG();

		User.loginUserPG(password = "test", userEmailAddress = "test@liferay.com");

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "User Groups"
		);

		UserGroup.assignMemberCP(
			userGroupName = "UG UserGroup Name",
			userScreenName = "usersn"
		);

		User.logoutPG();

		User.loginUserPG(password = "test", userEmailAddress = "userea@liferay.com");

		UserBar.gotoProfile();

		var key_pageName = "Welcome";

		AssertTextPresent(locator1 = "Home#PAGE_1", value1 = "Welcome");

		AssertTextPresent(locator1 = "Home#PAGE_2", value1 = "Home");

		AssertTextPresent(locator1 = "Home#PAGE_3", value1 = "Wiki");

		UserBar.gotoDashboard();

		AssertTextPresent(locator1 = "Home#PAGE_1", value1 = "Welcome");

		if (IsElementPresent(locator1 = "Home#PAGE_2")) {
			AssertTextNotEquals(locator1 = "Home#PAGE_2", value1 = "Home");
		}

		if (IsElementPresent(locator1 = "Home#PAGE_3")) {
			AssertTextNotEquals(locator1 = "Home#PAGE_3", value1 = "Wiki");
		}

		User.logoutPG();

		User.loginUserPG(password = "test", userEmailAddress = "test@liferay.com");

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "User Groups"
		);

		UserGroup.removeMemberCP(
			userGroupName = "UG UserGroup Name",
			userScreenName = "test"
		);
	}

	@priority = "4"
	test ViewUserGroupPermissionsNoAsUser {
		JSONRole.addRegularRole(
			roleKey = "Roles Regrole Name",
			roleTitle = "Roles Regrole Name"
		);

		Permissions.definePermissionViaJSONAPI(
			resourceAction = "VIEW_CONTROL_PANEL",
			resourceName = "90",
			roleTitle = "Roles Regrole Name"
		);

		Permissions.definePermissionViaJSONAPI(
			resourceAction = "VIEW",
			resourceName = "com.liferay.portal.kernel.model.UserGroup",
			roleTitle = "Roles Regrole Name"
		);

		Permissions.definePermissionViaJSONAPI(
			resourceAction = "ACCESS_IN_CONTROL_PANEL",
			resourceName = "com_liferay_user_groups_admin_web_portlet_UserGroupsAdminPortlet",
			roleTitle = "Roles Regrole Name"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		User.addCP(
			userEmailAddress = "userea1@liferay.com",
			userFirstName = "userfn1",
			userLastName = "userln1",
			userScreenName = "usersn1"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		User.editPasswordCP(
			userEmailAddress = "userea1@liferay.com",
			userScreenName = "usersn1"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		User.assignRegularRoleCP(
			roleTitle = "Roles Regrole Name",
			userScreenName = "usersn1"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		User.addCP(
			userEmailAddress = "userea2@liferay.com",
			userFirstName = "userfn2",
			userLastName = "userln2",
			userScreenName = "usersn2"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		User.addCP(
			userEmailAddress = "userea3@liferay.com",
			userFirstName = "userfn3",
			userLastName = "userln3",
			userScreenName = "usersn3"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		Organization.addCP(orgName = "Organization Name", orgType = "Organization");

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		UsersAndOrganizationsNavigator.gotoOrganizations();

		Organization.addMemberCP(
			orgName = "Organization Name",
			userFirstName = "userfn1",
			userLastName = "userln1",
			userName = "userfn1 userln1",
			userScreenName = "usersn1"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Users and Organizations"
		);

		UsersAndOrganizationsNavigator.gotoOrganizations();

		Organization.addMemberCP(
			orgName = "Organization Name",
			userFirstName = "userfn2",
			userLastName = "userln2",
			userName = "userfn2 userln2",
			userScreenName = "usersn2"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "User Groups"
		);

		UserGroup.addCP(userGroupName = "UG UserGroup Name");

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "User Groups"
		);

		UserGroup.assignMemberCP(
			userGroupName = "UG UserGroup Name",
			userScreenName = "usersn2"
		);

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "User Groups"
		);

		UserGroup.assignMemberCP(
			userGroupName = "UG UserGroup Name",
			userScreenName = "usersn3"
		);

		User.logoutPG();

		User.loginUserPG(password = "test", userEmailAddress = "userea1@liferay.com");

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "User Groups"
		);

		var key_userGroupName = "UG UserGroup Name";

		AssertTextEquals(
			locator1 = "UserGroups#USER_GROUP_TABLE_NAME",
			value1 = "UG UserGroup Name"
		);

		AssertElementNotPresent(locator1 = "UserGroups#USER_GROUP_TABLE_ACTIONS");

		User.logoutUserPG();

		User.loginPG(password = "test", userEmailAddress = "test@liferay.com");
	}

	@priority = "4"
	test ViewUserGroupSiteRolePermissions {
		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "Roles"
		);

		RoleNavigator.gotoRoleType(roleType = "Site");

		Role.add(roleTitle = "Roles Siterole Name");

		ProductMenu.gotoPortlet(
			category = "Users",
			panel = "Control Panel",
			portlet = "User Groups"
		);

		UserGroup.addCP(userGroupName = "UG UserGroup Name");

		PermissionsInline.gotoUserGroupSitePermissionsCP(
			userGroupName = "UG UserGroup Name"
		);

		var key_roleTitle = "Roles Siterole Name";

		SelectFrame(locator1 = "IFrame#DIALOG");

		AssertTextEquals(
			locator1 = "Permissions#CONTENT_PERMISSIONS_ROLE_NAME",
			value1 = "Roles Siterole Name"
		);
	}
}