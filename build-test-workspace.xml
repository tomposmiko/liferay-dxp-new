<?xml version="1.0"?>

<project basedir="." name="portal-test-workspace" xmlns:antelope="antlib:ise.antelope.tasks">
	<import file="build-test.xml" />

	<macrodef name="deploy-workspace-client-extension">
		<attribute name="workspace.client.extension.name" />

		<sequential>
			<local name="workspace.name" />

			<propertyregex
				input="@{workspace.client.extension.name}"
				property="workspace.name"
				regexp="(liferay-[^-]+)-.*"
				replace="\1-workspace"
			/>

			<local name="workspace.client.extension.dir" />

			<property name="workspace.client.extension.dir" value="${project.dir}/workspaces/${workspace.name}/client-extensions/@{workspace.client.extension.name}" />

			<if>
				<available file="${workspace.client.extension.dir}" />
				<then>
					<gradle-execute dir="${workspace.client.extension.dir}" task="clean" />

					<gradle-execute dir="${workspace.client.extension.dir}" task="assemble" />

					<copy
						file="${workspace.client.extension.dir}/dist/@{workspace.client.extension.name}.zip"
						todir="${liferay.home}/deploy"
					/>
				</then>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="deploy-workspace-client-extensions">
		<sequential>
			<propertycopy from="workspaces.client.extension.names[${workspace.name}]" name="workspaces.client.extension.names" override="true" />

			<for list="${workspaces.client.extension.names}" param="workspace.client.extension.name">
				<sequential>
					<deploy-workspace-client-extension workspace.client.extension.name="@{workspace.client.extension.name}" />
				</sequential>
			</for>
		</sequential>
	</macrodef>

	<macrodef name="start-workspace">
		<sequential>
			<deploy-workspace-client-extensions />
		</sequential>
	</macrodef>

	<macrodef name="stop-workspace">
		<sequential>
		</sequential>
	</macrodef>

	<target name="deploy-workspace-client-extension">
		<fail message="Please set the property ${workspace.client.extension.name}." unless="workspace.client.extension.name" />

		<deploy-workspace-client-extension workspace.client.extension.name="${workspace.client.extension.name}" />
	</target>

	<target name="start-workspace">
		<fail message="Please set the property ${workspace.name}." unless="workspace.name" />

		<stop-workspace />

		<start-workspace />
	</target>

	<target name="stop-workspace">
		<fail message="Please set the property ${workspace.name}." unless="workspace.name" />

		<stop-workspace />
	</target>
</project>